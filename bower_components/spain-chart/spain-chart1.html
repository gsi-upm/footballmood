<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<dom-module id="spain-chart">

<style is="custom-style">
  @import url("../../styles/app-theme.html");
</style>
<link rel="import" type="css" href="spain-chart.css">
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-composite-projections/0.3.5/conicConformalSpain-proj.min.js"></script>

 <template>

 	<style>
		#marco {
		  overflow: hidden;
		  margin: 0;
		  font-size: 14px;
		  font-family: "Helvetica Neue", Helvetica;
		}

		#spain {
		  /*position: absolute;*/
		  top: 0px;
		  left: 0px;
		}
		.subunit.ESC { fill: #ddc; }
		.subunit.ESI { fill: #cdd; }
		.subunit.ESX { fill: transparent; }
		.subunit.SEC { fill: #dcd; }
		.subunit.SEM { display: none; }

		.subunit {
		  stroke: #000;
		  stroke-linejoin: round;
		}

		.subunit-boundary {
		  fill: none;
		  stroke: #777;
		  stroke-linejoin: round;
		}

		.province {
		  stroke: #000;
		  stroke-dasharray: 2,2;
		  stroke-linejoin: round;
		}
		.tweet-details{display: none;}
		.cara:hover + .tweet-details{

			display: block;
		}

		.place-label {
		  font-size: 0.5em;
		}	
	</style>

  	<paper-material elevation="1">
  	<div class="top-bar">
        <iron-icon icon="{{icon}}"></iron-icon>
        <span>{{title}}</span>
    </div>
  	<div id="marco">
 	 <div id="spain"></div>
 	</div>
 	</paper-material>

 </template>

 <script>

    Polymer({

      is: 'spain-chart',

      properties: {

	      icon: {
	          type: String,
	          value: "language"
	        },

	      index: {
	          type: String
	        },

	      subindex: {
	          type: String
	        },

	      extraId: {
	          type: String
	        },

	      fields: {
	          type: Array,
	          value: function() { return []; }
	        },

	      query: {
	          type: String,
	          observer: '_queryChanged'
	        },

	      title: {
	          type: String,
	          value: "Geo Chart"
	        }
	  },

      ready: function(){

      	this.queryDefault();
      	
      	
      	
	  },
	   d3geoconicConformalSpain: function(){
	    	function n(n){var o=n[0],i=n[1];return t=null,e(o,i),t||r(o,i),t}var t,e,r,o=d3.geo.conicConformal().center([2,37.5]),i=d3.geo.conicConformal().center([-9.6,26.4]),a={point:function(n,e){t=[n,e]}};return n.invert=function(n){var t=o.scale(),e=o.translate(),r=(n[0]-e[0])/t,a=(n[1]-e[1])/t;return(a>=-.10779&&.067673>a&&r>=-.1866&&.0255>r?i:o).invert(n)},n.stream=function(n){var t=o.stream(n),e=i.stream(n);return{point:function(n,r){t.point(n,r),e.point(n,r)},sphere:function(){t.sphere(),e.sphere()},lineStart:function(){t.lineStart(),e.lineStart()},lineEnd:function(){t.lineEnd(),e.lineEnd()},polygonStart:function(){t.polygonStart(),e.polygonStart()},polygonEnd:function(){t.polygonEnd(),e.polygonEnd()}}},n.precision=function(t){return arguments.length?(o.precision(t),i.precision(t),n):o.precision()},n.scale=function(t){return arguments.length?(o.scale(t),i.scale(t),n.translate(o.translate())):o.scale()},n.translate=function(t){if(!arguments.length)return o.translate();var c=o.scale(),l=+t[0],s=+t[1];return e=o.translate(t).clipExtent([[l-.1291*c,s-.1683*c],[l+.0309*c,s+.0517*c]]).stream(a).point,r=i.translate([l-.067*c,s+.081*c]).clipExtent([[l-.1866*c,s+.02557*c],[l-.10779*c,s+.06767*c]]).stream(a).point,n},n.getCompositionBorders=function(){var n=o([-13,35.3]),t=o([-6.4,34]);return"M"+n[0]+" "+n[1]+"L"+t[0]+" "+n[1]+"L"+t[0]+" "+t[1]},n.scale(2500)
	    },


	  
	  _draw: function(data){


	  	
	  	/*var width = 600,
		    height = 430;
		var svg = d3.select(this.$.spain).append("svg")
		.attr("width", width)
		.attr("height", height);
		d3.json("es.json", function(error, es) {
		    if (error) return console.error(error);
		    //console.log(es);
		    var subunits = topojson.feature(es, es.objects.subunits);
		    var provinces = topojson.feature(es, es.objects.provinces);
		    var projection = d3.geo.mercator()
		    .scale(1900)
		    .center([0, 40])
		    //.translate([360, height / 2]);
		    .translate([360, 200]);
		    //console.log(es.objects.places.features);
		    var path = d3.geo.path()
		    .projection(projection);
		    svg.selectAll(".province")
		      .data(provinces.features)
		      .enter()
		      .append("path")
		      .attr("class", function(d) {
		       //console.log(d.geometry.coordinates);
		       return "province " + d.properties.name; })
		      .attr("d", path)
		      .style('fill', function(d) { return d3.hsl(Math.random() * 100, 0.5, 0.5); });
		    svg.selectAll(".subunit")
		      .data(subunits.features)
		      .enter()
		      .append("path")
		      .attr("class", function(d) { return "subunit " + d.id; })
		      .attr("d", path);
		    svg.append("path")
		      .datum(topojson.mesh(es, es.objects.subunits, function(a, b) { return a !== b && a.id !== "ESP"; }))
		      .attr("d", path)
		      .attr("class", "subunit-boundary");*/
		    /*svg.append("path")
		      .datum(topojson.feature(es, es.objects.places))
		      .attr("d", path)
		      .attr("class", "place");*/
		    //console.log(topojson.feature(es, es.objects.places));
		    //console.log(data);
		   
		    var width = 960,
			    height = 500;
			var colores = {"PP":"#03a9e7","PSOE":"#ff2f2e","IU":"#149f27","UPyD":"#d64b8c","CiU":"#024c97","Amaiur":"#b0d2e9",
			"PNV":"#0f7c2f","ERC":"#f9d43f","Compromís":"#faddaa","Podemos":"#82398a","Ciudadanos":"#e28535","Otros":"#e8e8e8"};
			var sentcolor = {"neutral": "grey", "positive": "#03a9e7", "negative": "#149f27"};
			var projection = this.d3geoconicConformalSpain()

			var path = d3.geo.path()
			.projection(projection);


			var svg = d3.select(this.$.spain).append("svg")
			    .attr("width", width)
			    .attr("height", height);

			var div = d3.select("body").append("div")
			        .attr("class", "tooltip")
			        .style("opacity", 0);
			var that = this;
			var citysentiment = {"Almería":{"sentimiento":"neutral"},
									"Cádiz":{"sentimiento":"neutral"},
									"Córdoba":{"sentimiento":"neutral"},
									"Granada":{"sentimiento":"neutral"},
									"Huelva":{"sentimiento":"neutral"},
									"Jaén":{"sentimiento":"neutral"},
									"Málaga":{"sentimiento":"neutral"},
									"Sevilla":{"sentimiento":"neutral"},
									"Huesca":{"sentimiento":"neutral"},
									"Teruel":{"sentimiento":"neutral"},
									"Zaragoza":{"sentimiento":"neutral"},
									"Asturias": {"sentimiento":"neutral"},
									"Balears, Illes": {"sentimiento":"neutral"},
									"Palmas, Las": {"sentimiento":"neutral"},
									"Santa Cruz de Tenerife": {"sentimiento":"neutral"},
									"Cantabria": {"sentimiento":"neutral"},
									"Albacete": {"sentimiento":"neutral"},
									"Ciudad Real": {"sentimiento":"neutral"},
									"Cuenca": {"sentimiento":"neutral"},
									"Guadalajara":{"sentimiento":"neutral"},
									"Toledo":{"sentimiento":"neutral"},
									"Ávila":{"sentimiento":"neutral"},
									"Burgos":{"sentimiento":"neutral"},
									"León":{"sentimiento":"neutral"},
									"Palencia":{"sentimiento":"neutral"},
									"Salamanca":{"sentimiento":"neutral"},
									"Segovia":{"sentimiento":"neutral"},
									"Soria":{"sentimiento":"neutral"},
									"Valladolid":{"sentimiento":"neutral"},
									"Zamora":{"sentimiento":"neutral"},
									"Barcelona":{"sentimiento":"neutral"},
									"Girona":{"sentimiento":"neutral"},
									"Lleida":{"sentimiento":"neutral"},
									"Tarragona":{"sentimiento":"neutral"},
									"Ceuta":{"sentimiento":"neutral"},
									"Alicante":{"sentimiento":"neutral"},
									"Castellón":{"sentimiento":"neutral"},
									"Valencia":{"sentimiento":"neutral"},
									"Badajoz":{"sentimiento":"neutral"},
									"Cáceres":{"sentimiento":"neutral"},
									"Coruña, A":{"sentimiento":"neutral"},
									"Lugo":{"sentimiento":"neutral"},
									"Ourense":{"sentimiento":"neutral"},
									"Pontevedra":{"sentimiento":"neutral"},
									"Rioja, La":{"sentimiento":"neutral"},
									"Madrid":{"sentimiento":"neutral"},
									"Melilla":{"sentimiento":"neutral"},
									"Murcia":{"sentimiento":"neutral"},
									"Navarra":{"sentimiento":"neutral"},
									"Álava":{"sentimiento":"neutral"},
									"Guipúzcoa":{"sentimiento":"neutral"},
									"Vizcaya":{"sentimiento":"neutral"}}


			for (var i=0; i<data.length;i++){
				if (data[i].city == "Valencia"){
					console.log(data[i].sentiment);
					sentiment0 = data[i].sentiment;
					citysentiment.Valencia = {sentimento: "positive"};
				}
				if (data[i].city == "Barcelona"){
					console.log(data[i].sentiment);
					sentiment0 = data[i].sentiment;
					citysentiment.Barcelona = {sentimento: "negative"};
				}
			}
			console.log(citysentiment);
			  d3.json("provincias.json", function(error, provincias) {
			  d3.json("https://cdn.rawgit.com/rveciana/5919944/raw//resultados.json", function(error, resultados) {
			  var land = topojson.feature(provincias, provincias.objects.provincias);
			  svg.selectAll("path")
			      .data(land.features)
			      .enter()
			      .append("path")
			      .attr("d", path)
			      .attr("fill", function(d){

			       // var ganador = Object.keys(resultados[d.properties.nombre])[0];
			  			       
			       // return colores[ganador];
			       //console.log(citysentiment[d.properties.nombre].sentimiento)

			       //var sentiment = Object.keys(citysentiment[d.properties.nombre])[1];
			       var sentimentcolor = citysentiment[d.properties.nombre].sentimiento;
			       console.log(sentimentcolor)
			       console.log(sentcolor[sentimentcolor])
			       //console.log(sentiment)
			       return sentcolor[sentimentcolor];

			       });
			      /*.on("mouseover", function(d) {
			            d3.select(this)
			                .transition()
			                .style("stroke-width", 4);

			            div.transition()
			                .duration(200)
			                .style("opacity", 0.9);
			            var resultados_provincia  = "";
			            var partido;
			            for (partido in resultados[d.properties.nombre]) {
			              resultados_provincia += partido + ": " + resultados[d.properties.nombre][partido] + "</br>";
			            }
			            div.html("Resultados: <br/>" + resultados_provincia)
			                .style("left", (d3.event.pageX) + "px")
			                .style("top", (d3.event.pageY - 28) + "px");
			            })
			        .on("mouseout", function(d) {
			            d3.select(this)
			                .transition()
			                .style("stroke-width", 0);
			            div.transition()
			                .duration(500)
			                .style("opacity", 0);
			        });*/

			        svg
			          .append("path")
			            .style("fill","none")
			            .style("stroke","#000")
			            .attr("d", projection.getCompositionBorders());
			    
			        that._drawfaces(data);
			  });
			  });
				
			},

			_drawfaces: function(data){
				var svg = d3.select(this.$.spain).select("svg");
				var projection = this.d3geoconicConformalSpain();

				for (var i=0; i<data.length;i++){
			    	if (data[i].city == "Barcelona"){
			    		data[i].coordinates = [1.6809586232530336+(Math.random()*0.4),(41.38505768239248)+(Math.random()*0.4)]
			    	}
			    	if (data[i].city == "Madrid"){
			    		data[i].coordinates = [-4.1842519049503775+(Math.random()*0.4),40.401350962116155+(Math.random()*0.4)]
			    	}
			    	if (data[i].city == "Valencia"){
			    		data[i].coordinates = [-0.9027949018342696+(Math.random()*0.4),39.487101366588405+(Math.random()*0.4)]
			    	}
			    	if (data[i].sentiment == "neutral"){
			    		data[i].image = "angry-face.png"
			    	}
			    	if (data[i].sentiment == "positive"){
			    		data[i].image = "grinning-face.png"
			    	}
			    	if (data[i].sentiment == "negative"){
			    		data[i].image = "crying-face.png"
			    	}	
			    }
			    var faceIcon = svg.selectAll('image').data([0]);
			    for (var i=0; i<data.length;i++){
			    faceIcon.enter()
					.append('svg:image')
					.attr('xlink:href', 'images/'+data[i].image)
					.attr('width', '26').attr('height', '26')
					.attr("class","cara")
	           		//.attr('transform', function(d) {return 'translate(' + position + ')';});
	           		.attr('transform', function(d) {return 'translate(' + projection(data[i].coordinates) + ')';});

	           	svg.selectAll(".place-label").data([0]).enter()
	           		.append("text")
	           		.attr("class", "tweet-details")
	           		.attr('transform','translate(15,397)')
	           		.text(data[i].text);
	           	}

			},

		    	    		
		    
		    //console.log(data);
		    
		    /*svg.selectAll(".place-label")
		      .data(topojson.feature(es, es.objects.places).features)
		      .enter().append("text")
		      .attr("class", "place-label")
		      .attr("transform", function(d) { return "translate(" + projection(d.geometry.coordinates) + ")"; })
		      .attr("dy", ".35em")
		      .text(function(d) { return d.properties.name; });*/
		    /*svg.selectAll(".place-label")
		      .attr("x", function(d) { return d.geometry.coordinates[0] > -1 ? 6 : -6; })
		      .style("text-anchor", function(d) { return d.geometry.coordinates[0] > -1 ? "start" : "end"; });*/
		//});

	   _queryChanged: function() {
          this.query ? this.queryChange(this.query) : this.queryDefault();
        },

	  queryDefault: function() {
	  	d3.select(this.$.spain).select("svg").remove();
        var client = new $.es.Client({
          hosts: this.host
        });
        var that = this
        client.search({
        // undocumented params are appended to the query string
        index: this.index,
        type: this.subindex,
        body: {
          size: 1,
          query: {
        	"bool" : {
	            "must" : [ 
	                { "match": { "user.location" : "Madrid Barcelona Valencia" } }
	               
	            ]
         }
    },
             	
       	  fields: [ "user.location" , "text" ] 
         	
          
        }
        }).then(function (resp) {
          var hits = resp.hits.hits;
          var results = []
          hits.forEach(function(entry) {
            results.push(entry.fields);
          });
        	//console.log(results);
        	function filterbylocation(obj){
        		if ('user.location' in obj != undefined ){
        			return true
        		}else{
        			return false
        		}
        	}
        	resultsclean = results.filter(filterbylocation);
        	//console.log(resultsclean);
        	var sitios = []
        	for(var i = 0; i<resultsclean.length; i++){
        	//console.log(resultsclean[i]);
        	if((resultsclean[i]["user.location"][0]).indexOf("Barcelona")>-1){
        		sitios.push({city:"Barcelona", sentiment: "negative", coordinates:[], text: resultsclean[i]["text"][0]});
        	}
        	if((resultsclean[i]["user.location"][0]).indexOf("Madrid")>-1){
        		sitios.push({city:"Madrid", sentiment: "positive", coordinates:[], text: resultsclean[i]["text"][0]});
        	}
        	if((resultsclean[i]["user.location"][0]).indexOf("Valencia")>-1){
        		sitios.push({city:"Valencia", sentiment: "neutral", coordinates:[], text: resultsclean[i]["text"][0]});
        	}
        	}
        	//console.log(sitios);
          that._draw(sitios);
        });
	      
	    },
	    queryChange: function() {
	    d3.select(this.$.spain).select("svg").remove();
        var client = new $.es.Client({
          hosts: this.host
        });
        var that = this
        client.search({
        // undocumented params are appended to the query string
        index: this.index,
        type: this.subindex,
        body: {
          size: 1,
          query: {
        	"bool" : {
	            "must" : [ { "match": { "user.location" : "Madrid Barcelona Valencia" } },
	            		   { "match": { "text": this.query   }}
	               
	           			 ]
        			 }
    			},
             	
       	  fields: [ "user.location" , "text" ] 
         	
          
        }
        }).then(function (resp) {
          var hits = resp.hits.hits;
          var results = []
          hits.forEach(function(entry) {
            results.push(entry.fields);
          });
        	//console.log("engendro"+results.length);
        	function filterbylocation(obj){
        		if ('user.location' in obj != undefined ){
        			return true
        		}else{
        			return false
        		}
        	}
        	resultsclean = results.filter(filterbylocation);
        	//console.log(resultsclean);
        	var sitios = []
        	for(var i = 0; i<resultsclean.length; i++){
        	//console.log(resultsclean[i]);
        	if((resultsclean[i]["user.location"][0]).indexOf("Barcelona")>-1){
        		sitios.push({city:"Barcelona", sentiment: "negative", coordinates:[], text: resultsclean[i]["text"][0]});
        	}
        	if((resultsclean[i]["user.location"][0]).indexOf("Madrid")>-1){
        		sitios.push({city:"Madrid", sentiment: "positive", coordinates:[], text: resultsclean[i]["text"][0]});
        	}
        	if((resultsclean[i]["user.location"][0]).indexOf("Valencia")>-1){
        		sitios.push({city:"Valencia", sentiment: "neutral", coordinates:[], text: resultsclean[i]["text"][0]});
        	}
        	}
        	//console.log(sitios);


          that._draw(sitios);
        });
	      
	    }
	   


	});
</script>
</dom-module>
